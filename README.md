# Predicting Which Patients with Cancer Patients will see a Psychiatrist or Counsellor from their Initial Oncology Consultation Document Using Natural Language Processing

By John-Jose Nunez, on behalf of the co-authors

## Overview

For the manuscript "Predicting Which Cancer Patients Will See a Psychiatrist or Counsellor From Their Initial Oncology 
Consultation Document Using Natural Language Processing" submitted to Nature Communications.

This code base is the implementation of NLP methods to predict which cancer patients will see a psychiatrist, or a counsellor,
within the 12 months following their initial oncology consultation. The prediction is made using the documented generated by 
the medical or radiation oncologist at this initial visit. 

This code base is loosely based on the [Hedwig NLP repo](https://github.com/castorini/hedwig), but with extensive changes
and generally starting fresh due to the large changes in PyTorch 1.9.0 and especially torchtext 0.10.0. 

The code base is all written in Python 3.9, and besides install Python and libraries, does not 
requires the installation of any other programs. 

## System Requirements

### Operating System
This code was developed and ran on Windows Server 2012 R2 Standard, though we do not expect any problems
running this code on a Linux or MacOS system as Python is generally OS-agnostic. 

### Software dependencies and environment

For all python packages installed and their versions, please see the exported [conda enviroment export](./scar_nlp_env.yaml). 

Notable packages and their version numbers include:
- python 3.9.7
- pandas 1.3.3 
- numpy 1.21.2
- pytorch 1.9.0
- pytorch-lightning 1.4.9
- torchtext 0.10.0
- transformers 4.11.3

### Hardware requirements

We trained and ran our code on a shared GPU through a NVIDIA GRID V100D-16Q virtualization. Our driver was using CUDA 10.2, V10.2.89
Our code does support using CPU instead of GPU, though times to train and even evaluate may become prohibitive. 

Please consult [NVIDIA ](https://developer.nvidia.com/cuda-gpus#compute) and [PyTorch](https://pytorch.org/get-started/locally/) regarding
graphic card compatibility, as this varies depending on CUDA and version of PyTorch used. 

## Installation Guide

1. Ensure Python is installed, including required packages. 
2. Clone the Github repository, or extract a .zip, of the codebase. 
3. If using BERT as in our work, download the large language model [bert-based-uncased](workhttps://huggingface.co/bert-base-uncased)
3. Run commands as per below. Directory and file paths can be specified with the command-line, use `-h` for help on arguments, e.g.

```
python -m models.cnn -h
```

We expect this to take no more than a few minutes. 

## Training/Fine-tuning NLP Models

Models are ran as python modules. Arguments can be based through the command line. E.g.

```python -m cnn --target "dspln_PSYCHIATRY_12" --batch-size 16```

See [models](./models) for the various deployed models. 

See [trainers](./trainers) for the trainers used to train the models

See [evaluators](./evaluators) for the code used to evaluate models

See [results](./results) for the final results and trained models

See [tables](./results) for some code used to generate tables as the raw data used for tables

For training the models on Windows, .bat files are provided that contain the command-line code,
as found in the [bats](./bats) folder. Sorry, I had to use Windows, as IT didn't support Linux on their virtualization.

To use BERT, please first download bert-base-uncased from [HuggingFace](https://huggingface.co/bert-base-uncased/tree/main)
The pytorch_model, config, and vocab files should be placed in a folder named bert-base-uncased, whose directory
in provided in the argument/default argument. 

# Visualizing and Understanding Models

See the [viz](./viz) folder for jupyter notebooks used to visualize and understand the models.

Thank you for your interest in our work! Please don't hesitate to reach out - John-Jose, johnjose.nunez@bccancer.bc.ca

# Licence

Copyright (C) 2023 John-Jose Nunez

This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public 
License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later
version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied
 warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with this program.  
If not, see <https://www.gnu.org/licenses/>



